---
sidebar_position: 1
---

# Azure & Dynatrace: Initial Setup

Welcome to the Azure & Dynatrace 2024 Hot session!  
We'll be playing several common roles today the fictional organization of "Dynabank". Below are suggestions on tabs to keep open.

You have multiple logins!

- Dynatrace University (your existing login)
- Azure Portal login (classX@suchcodewow.io)
- Dynatrace login (attendee#@dynatracelabs.com)

## Setup Confirmation/Recommendations

### Tab 1: Dynatrace University with terminal (Hot Attendee)

Use the email and password you use to login to Dynatrace University.

#### Azure Terminal

When you start the University terminal, you'll need to run the following command to connect it to your Azure login.

```bash
az login
```

#### Pepper

While at the command line, run Pepper:

```bash
curl https://www.suchcodewow.io/manifests/pepper.ps1 > ~/pepper.ps1 && pwsh ~/pepper.ps1 -c
```

Pepper will take an inventory of what is loaded. Confirm:

| Component        | Name                                        |
| ---------------- | ------------------------------------------- |
| Resource group   | scw-group-[classname]                       |
| AKS cluster      | scw-AKS-[classname]                         |
| App Service Plan | scw-ASP-[classname]                         |
| Web App          | scw-webapp-[classname]                      |
| Dynatrace        | tenant shown in University & 5/5 pods ready |

We'll use Pepper at several points during the session. You can leave it running. If you do exit, you can use 'up-arrow' to recall the command.  
Or you can just copy and paste from above into your terminal again.

### Tab 2: This guide (Hot Attendee)

You're already here. You did it!

### Tab 3: Azure Portal (Enterprise Cloud Operations)

Confirm login to [Azure portal](https://portal.azure.com) with [classname]@suchcodewow.io. Password provided in University.

You can check out the resource pre-deployed for you. They are listed below. For example, if you search for 'resource group' in the top bar of Azure, you can find your resource group.

Resources created:

| Component        | Name                   |
| ---------------- | ---------------------- |
| Resource group   | scw-group-[classname]  |
| AKS cluster      | scw-AKS-[classname]    |
| App Service Plan | scw-ASP-[classname]    |
| Web App          | scw-webapp-[classname] |

### Tab 4: Dynatrace (Dynatrace Administrator)

Login to Dynatrace tenant using URL, class name, password. Provided in class spreadsheet.

Confirm that Dynatrace is connected to your Azure resources & make the following updates.

1. Open the "Apps" page.
1. Click Kubernetes (not the "new" one).
1. Check that you see a cluster running similar to "k8s[classname]".

#### Logs

1. Go to Settings -> Log Monitoring -> Log Ingest Rules.
1. Toggle on [Built-in] Ingest all logs then click _Save changes_ bottom left of screen.

#### Bizevents

1. Go to Settings -> Preferences -> OneAgent features.
1. In the Filter by box, type `business event` and press ENTER: ![bizevent1](/img/bizevent1.png)
1. Toggle ON _Business Event [Opt-in]_ for .NET, Go, Java, Node.js, and Webserver. Select the drop-down arrow for each and toggle ON _Instrucmentation enabled_.
1. Click _Save Changes_ bottom left of screen.
1. Go to Settings -> Business Analytics -> OneAgent.
1. Click _App new capture rule_ and name it 'AllEvents'.
1. Click _Add trigger_ and set the following values:

| Key         | Value          |
| ----------- | -------------- |
| Data Source | Request - Path |
| Operator    | exists         |

![bizevents2](/img/bizevents2.png)

1. In the _Event meta data_ section, set the following values:

| Key                         | Value          |
| --------------------------- | -------------- |
| Event provider: Data Source | Fixed Value    |
| Event provider: Fixed Value | AzureHoT       |
| Event type: Data source     | Request - Path |
| Event type: Event category  | Fixed Value    |
| Event type: Fixed Value     | Request - Path |

1. In the _Event data_ section, click _Add data field_, and then set the following values:

| Key         | Value                             |
| ----------- | --------------------------------- |
| Field name  | params                            |
| Data source | Request - Query String parameters |
| Path        | \*                                |

1. Click _Add data field_ again and then set the following values:

| Key         | Value           |
| ----------- | --------------- |
| Field name  | responsebody    |
| Data source | Response - Body |
| Path        | \*              |

1. Click _Save changes_ in the bottom left.

#### Dynabank & APIM

Instamation also works through Azure APIM (API Management).

1. In Azure, search for 'APIM' and click on _API Management services_.
1. Click on the APIM for your region in the format _scw-[region]-apim_.
1. Click on _API's_ from the inset-left menu:
   ![apim1](/img/apim1.png)
1. And then click on _App Service_.
   ![apim2](/img/apim2.png)
1. In the configuration box in the _App Service_ section, Browse for and select your Instamation web application.
1. Copy the name provided into the API URL suffix box. Your Base URL should look something like:

```bash
https://scw-useast2-apim.azure-api.net/scw-webapp-colossalcactus
```

1. Click _Create_.
1. Find your API in the list, click on it (blue highlight), and then click _Settings_ at the top of the details box to the right (green highlight):
   ![apim3](/img/apim3.png)
1. Uncheck the _Subscription required_ option box (blue highlight). Click Save (green highlight). This will allow all connections to reach your Instamation service.
   ![apim4](/img/apim4.png)

:::tip Lab vs Real World
In a real-world scenario we wouldn't go without a subscription/authorization mechanism. We're doing it here to keep the focus on Observability vs application configuration. Dynatrace will detect all traffic just fine with security in place.
:::

4. Before leaving this screen, find the _Base URL_ of your service and copy it.
1. Confirm it worked by pasting this URL into a new tab of your browser. You should see your service respond just fine behind the apim!
1. In your Dynabank Operations portal (click orange button top right -> Operations), you can replace the Instamation Web App with the APIM version and click _save_. You should receive the same _succesfully configured_ message.

### Azure Log Forwarder

wget -q https://github.com/dynatrace-oss/dynatrace-azure-log-forwarder/releases/latest/download/dynatrace-azure-logs.sh -O dynatrace-azure-logs.sh && chmod +x ./dynatrace-azure-logs.sh \
&& ./dynatrace-azure-logs.sh --deployment-name $DEPLOYMENT_NAME --target-url $TARGET_URL --target-api-token $TARGET_API_TOKEN --resource-group $RESOURCE_GROUP --event-hub-connection-string $EVENT_HUB_CONNECTION_STRING --require-valid-certificate true

#### Fix

wget -q https://github.com/dynatrace-oss/dynatrace-azure-log-forwarder/releases/download/release-0.1.6/dynatrace-azure-log-forwarder.zip -O dynatrace-azure-log-forwarder.zip

az webapp deployment source config-zip -n lognerdycoast-function -g scw-group-nerdycoast --src dynatrace-azure-log-forwarder.zip

### Service Principal

To Deploy the service-principal,
Go to the Terminal Command line /Azure CLI
Run this command after adding the values from the previous command

```bash
az ad sp create-for-rbac --name <YourServicePrincipalName> --role reader --scopes /subscriptions/9939cbf8-8de6-49a1-a641-b664b214838f --query "{ClientID:appId,TenantID:tenant,SecretKey:password}"
```

The Command should give you the ClientID, TennatID and SecretKey
Next Navigate to your Dynatrace Tenant Provided for you
Go to Settings --> Cloud and Virtualization --> Azure
Click on Connect New instance
Fill in the connection name
Add the ClientID, SecretKey and TenantID that exported from the Terminal Command line /Azure CLI
Click Connect --> Your Azure Instance is now connected in Dynatrace
